generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Dream ID (Shared Auth) ────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  avatar         String?
  bio            String?   @db.Text
  dreamStatement String?   @db.Text
  skills         String[]  @default([])
  interests      String[]  @default([])
  emailVerified        DateTime?
  hashedPassword       String?
  onboardingCompleted  Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  stripeCustomerId String?
  stripeConnectId  String?

  accounts      Account[]
  sessions      Session[]
  dreamProfile  DreamProfile?
  sentMatches   Match[]       @relation("MatchSender")
  receivedMatches Match[]     @relation("MatchReceiver")
  sentMessages  Message[]     @relation("MessageSender")
  thoughts      Thought[]
  insightReports InsightReport[]
  dreamStories  DreamStory[]
  orders        Order[]
  following     Follow[]
  dreamUpdates  DreamUpdate[] @relation("DreamUpdates")
  dreamComments DreamComment[] @relation("DreamComments")
  preferences   UserPreferences?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ─── Dream Place ────────────────────────────────────────────

model DreamProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  dreamStatement  String   @db.Text
  dreamHeadline   String?
  dreamCategory   String?
  intent          String?  // "lead" | "join" | "partner" | "explore"
  skillsOffered   String[] @default([])
  skillsNeeded    String[] @default([])
  interests       String[] @default([])
  city            String?
  country         String?
  remotePreference String?  // "remote" | "local" | "hybrid"
  timezone         String?
  industryInterests String[] @default([])
  commitmentLevel  String?  // "full-time" | "part-time" | "weekends" | "flexible"
  experienceLevel  String?  // "student" | "early-career" | "mid-career" | "senior" | "executive"
  workStyleIdeation   Int?  @default(50)
  workStyleExecution  Int?  @default(50)
  workStylePeople     Int?  @default(50)
  workStyleThinking   Int?  @default(50)
  workStyleAction     Int?  @default(50)
  avatarUrl       String?
  bio             String?  @db.Text
  embedding       Float[]  @default([])
  onboardingCompleted Boolean @default(false)
  githubUrl       String?
  linkedinUrl     String?
  portfolioUrl    String?
  verificationLevel String @default("unverified")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamMembers TeamMember[]

  @@map("dream_profiles")
}

enum MatchStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model Match {
  id            String      @id @default(cuid())
  senderId      String
  receiverId    String
  matchScore    Float       @default(0)
  dreamScore    Float       @default(0)
  skillScore    Float       @default(0)
  valueScore    Float       @default(0)
  status        MatchStatus @default(PENDING)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  sender   User @relation("MatchSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MatchReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  messages Message[]

  @@unique([senderId, receiverId])
  @@map("matches")
}

model Message {
  id        String   @id @default(cuid())
  matchId   String
  senderId  String
  content   String   @db.Text
  createdAt DateTime @default(now())

  match  Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  sender User  @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// ─── Dream Teams & Projects ─────────────────────────────────

model DreamTeam {
  id             String   @id @default(cuid())
  name           String
  dreamStatement String   @db.Text
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  members   TeamMember[]
  projects  DreamProject[]
  checkIns  TeamCheckIn[]

  @@map("dream_teams")
}

enum TeamRole {
  LEADER
  CORE_DREAMER
  CONTRIBUTOR
  SUPPORTER
  DREAM_GUIDE
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      TeamRole @default(CONTRIBUTOR)
  joinedAt  DateTime @default(now())

  team    DreamTeam    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  profile DreamProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

enum ProjectStage {
  IDEATION
  TEAM_FORMATION
  ACTIVE_DEVELOPMENT
  LAUNCH
  COMPLETE
}

model DreamProject {
  id           String       @id @default(cuid())
  teamId       String
  name         String
  description  String       @db.Text
  stage        ProjectStage @default(IDEATION)
  skillsNeeded String[]     @default([])
  maxTeamSize  Int          @default(5)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  isTrial             Boolean  @default(false)
  trialDurationWeeks  Int?
  evaluationCriteria  String[] @default([])
  upvotes             Int      @default(0)
  isFeatured          Boolean  @default(false)

  team  DreamTeam     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tasks ProjectTask[]

  @@map("dream_projects")
}

model ProjectTask {
  id          String   @id @default(cuid())
  projectId   String
  title       String
  description String?  @db.Text
  status      String   @default("todo")
  assigneeId  String?
  sortOrder   Int      @default(0)
  priority    String   @default("P1")
  dueDate     DateTime?
  goodFirstContribution Boolean @default(false)
  skillsRequired String[] @default([])
  createdAt   DateTime @default(now())

  project DreamProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_tasks")
}

model TeamCheckIn {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  date      DateTime @default(now())
  mood      Int      @default(3)
  blockers  String?  @db.Text
  progress  String?  @db.Text
  createdAt DateTime @default(now())

  team DreamTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("team_check_ins")
}

// ─── Dream Store ─────────────────────────────────────────────

model DreamStory {
  id              String   @id @default(cuid())
  userId          String
  title           String
  statement       String   @db.Text
  coverImage      String?
  category        String?
  originStory     String?  @db.Text  // "How this dream started"
  processImages   String[] @default([])  // Behind-the-scenes photos
  impactStatement String?  @db.Text  // "What one sale means for this dream"
  isFeatured      Boolean  @default(false)
  isStaffPick     Boolean  @default(false)
  creatorStage    String?  // "early" | "growing" | "established"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestones Milestone[]
  products   Product[]
  orders     Order[]
  followers  Follow[]
  updates    DreamUpdate[]
  comments   DreamComment[]

  @@index([userId])
  @@map("dream_stories")
}

model Milestone {
  id           String   @id @default(cuid())
  dreamStoryId String
  title        String
  targetDate   DateTime
  completed    Boolean  @default(false)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())

  dreamStory DreamStory @relation(fields: [dreamStoryId], references: [id], onDelete: Cascade)

  @@map("milestones")
}

model Product {
  id           String   @id @default(cuid())
  dreamStoryId String
  title        String
  description  String   @db.Text
  price        Int      // cents
  images       String[] @default([])
  whyIMadeThis String?  @db.Text
  category     String?
  productType  String?  // "physical" | "digital" | "service" | "class"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dreamStory DreamStory @relation(fields: [dreamStoryId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@map("products")
}

enum OrderStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

model Order {
  id               String      @id @default(cuid())
  buyerId          String
  productId        String
  dreamStoryId     String
  amount           Int         // cents
  stripeFee        Int         @default(0)
  platformFee      Int         @default(0)
  creatorPayout    Int         @default(0)
  stripeSessionId  String?     @unique
  stripePaymentId  String?
  status           OrderStatus @default(PENDING)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  buyer      User       @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  dreamStory DreamStory @relation(fields: [dreamStoryId], references: [id], onDelete: Cascade)

  @@index([buyerId])
  @@index([dreamStoryId])
  @@map("orders")
}

model Follow {
  id           String   @id @default(cuid())
  followerId   String
  dreamStoryId String
  createdAt    DateTime @default(now())

  follower   User       @relation(fields: [followerId], references: [id], onDelete: Cascade)
  dreamStory DreamStory @relation(fields: [dreamStoryId], references: [id], onDelete: Cascade)

  @@unique([followerId, dreamStoryId])
  @@map("follows")
}

model DreamUpdate {
  id           String   @id @default(cuid())
  dreamStoryId String
  userId       String
  title        String
  content      String   @db.Text
  images       String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dreamStory DreamStory @relation(fields: [dreamStoryId], references: [id], onDelete: Cascade)
  user       User       @relation("DreamUpdates", fields: [userId], references: [id], onDelete: Cascade)

  @@index([dreamStoryId, createdAt(sort: Desc)])
  @@map("dream_updates")
}

model DreamComment {
  id           String   @id @default(cuid())
  dreamStoryId String
  userId       String
  content      String   @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dreamStory DreamStory @relation(fields: [dreamStoryId], references: [id], onDelete: Cascade)
  user       User       @relation("DreamComments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([dreamStoryId, createdAt(sort: Desc)])
  @@map("dream_comments")
}

// ─── User Preferences ────────────────────────────────────────

model UserPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  aiProcessingLevel   String   @default("standard") // "minimal" | "standard" | "detailed"
  dailyPromptEnabled  Boolean  @default(true)
  weeklyInsightEnabled Boolean @default(true)
  connectionAlerts    Boolean  @default(true)
  defaultView         String   @default("home") // "home" | "timeline" | "brain"
  thoughtsPerPage     Int      @default(20)
  embeddingEnabled    Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ─── Dream Brain ─────────────────────────────────────────────

enum ThoughtCategory {
  WORK
  IDEAS
  EMOTIONS
  DAILY
  LEARNING
  RELATIONSHIPS
  HEALTH
  FINANCE
  DREAMS
}

enum InputMethod {
  TEXT
  VOICE
}

model Thought {
  id                  String          @id @default(cuid())
  userId              String
  title               String
  body                String          @db.Text
  summary             String?         @db.Text
  category            ThoughtCategory @default(IDEAS)
  tags                String[]        @default([])
  keywords            String[]        @default([])
  importance          Int             @default(3)
  inputMethod         InputMethod     @default(TEXT)
  voiceFileUrl        String?
  voiceDurationSeconds Int?
  isFavorite          Boolean         @default(false)
  isArchived          Boolean         @default(false)
  isPinned            Boolean         @default(false)
  emotion              String?
  emotionSecondary     String?
  valence              Float?          @default(0)
  emotionConfidence    Float?          @default(0)
  actionItems          Json?           @default("[]")
  peopleMentioned      String[]        @default([])
  placesMentioned      String[]        @default([])
  embedding           Float[]         @default([])
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  user                User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  connectionsFrom     ThoughtConnection[] @relation("ConnectionSource")
  connectionsTo       ThoughtConnection[] @relation("ConnectionTarget")

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, category])
  @@map("thoughts")
}

model ThoughtConnection {
  id              String  @id @default(cuid())
  sourceThoughtId String
  targetThoughtId String
  score           Float   @default(0)
  reason          String? @db.Text
  createdAt       DateTime @default(now())

  sourceThought   Thought @relation("ConnectionSource", fields: [sourceThoughtId], references: [id], onDelete: Cascade)
  targetThought   Thought @relation("ConnectionTarget", fields: [targetThoughtId], references: [id], onDelete: Cascade)

  @@unique([sourceThoughtId, targetThoughtId])
  @@map("thought_connections")
}

model InsightReport {
  id          String   @id @default(cuid())
  userId      String
  periodType  String   // "weekly" | "monthly"
  periodStart DateTime
  periodEnd   DateTime
  content     Json
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodType, periodStart])
  @@map("insight_reports")
}
